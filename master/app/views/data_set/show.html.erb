<script type="text/javascript">
$(document).ready(function(){
  $("#data_set_tree").jstree({
    'core':{
      'data':{
        url: "/data_set/partial_treeviews.<%= params[:id] %>"
      }
    }
  });
});
</script>
<%= render 'shared/td' %>
<h1>Project <%= session[:project] %></h1>
<hr />
<h3>DataSet</h3>
<table>
  <tr><th>ID</th><th>Name</th><th>Samples</th><th>Parent</th><th>Child(ren)IDs</th><th>Created</th><th>BFabricID</th></tr>
  <% if @data_set %>
  <tr>
    <td><%= @data_set.id %></td>
    <td><%= td @data_set.name %></td>
    <td><%= @data_set.samples.length %></td>
    <td><%= link_to td(@data_set.data_set.name), "/data_set/p#{session[:project]}/#{@data_set.parent_id}" if @data_set.data_set %></td>
    <td>
      <% @data_set.data_sets.each do |child| %>
        <%= link_to child.id, "/data_set/#{child.id}" %>
        <%= "," unless child == @data_set.data_sets.last %>
      <% end %>
    </td>
    <td><%= @data_set.created_at.to_s.gsub(/UTC/,'') %></td>
    <td><%= @data_set.bfabric_id %></td>
  </tr>
  <% end %>
</table>
<ul id="data_set_tree" class="filetree"></ul>
<%= form_tag(:controller => 'data_set',:action => 'edit') do %>
  <% if @data_set.comment %>
    <%= @data_set.comment %><br />
    <%= submit_tag 'edit comment', :name=>'edit_option' %>
  <% else %>
    <%= submit_tag 'add comment', :name=>'edit_option' %>
  <% end %>

  <%= hidden_field :data_set, :id, :value=>@data_set.id %>
  <%= submit_tag 'edit name', :name=>'edit_option' %>
<% end %>
<%= button_to "download as tsv", "/data_set/#{@data_set.id}/save_as_tsv", :method => :get %>

<hr />
<h3>Samples</h3>
<% if @data_set %>
    <div style="width:830px; overflow-x:scroll;">
  <% if @data_set.samples.length > 20 %>
    <div style="height:450px; overflow-y:scroll;">
  <% end %>
<table>
  <tr>
    <% @data_set.factor_first_headers.each do |header| %>
      <th><%= header %></th>
    <% end %>
  </tr>
  <% @data_set.samples.each do |sample| %>
    <tr>
      <% @data_set.factor_first_headers.each do |header| %>
        <td>
          <% unless @file_exist[sample.to_hash[header].to_s] %>
            <font color=red><%= File.basename(sample.to_hash[header].to_s) %></font>
          <% else %>
            <% file_path = sample.to_hash[header].to_s %>
            <% file_name = File.basename(file_path) %>
            <% if header.tag?('Link') %>
              <% if file_path =~ /^http/ %>
                <%= link_to td(file_name), file_path %>
              <% elsif @fgcz %>
                <%= link_to td(file_name), File.join('http://fgcz-gstore.uzh.ch/projects', file_path) %>
              <% else %>
                <%= link_to td(file_name), File.join('/projects', file_path) %>
              <% end %>
            <% elsif header.tag?('File') %>
               <%= td file_name %>
            <% elsif @sample_invalid_name[file_name] %>
               <font color=red><%= td file_name %></font>
            <% else %>
               <%= td file_path %>
            <% end %>
          <% end %>
        </td>
      <% end %>
    </tr>
  <% end %>
</table>
  <% if @data_set.samples.length > 20 %>
    </div>
  <% end %>
    </div>
<%= button_to 'edit sample', "/sample/#{@data_set.id}" %>
<% end %>
<hr />

<% unless @file_exist.values.inject{|a,b| a and b}%>
  <% if @sample_path.length == 1 %>
    <%= button_to "Go gstore", File.join("/projects/", @sample_path.first), :method=>:get %>
  <% end %>
  <font color=red>RED file(s) or the following does not exist in gstore:</font> <%= SushiFabric::GSTORE_DIR %><br />
  <ul>
  <% @file_exist.select{|file, exist| !exist}.each do |file, exist| %>
    <li><%= file %></li>
  <% end %>
  </ul>
<% end %>
<% if @sample_path.length == 1 %>
  <%= button_to "Go gstore", File.join("/projects/", @sample_path.first), :method=>:get %>
<% end %>
  <% @sample_path.sort.each do |path| %>
    <%= link_to "#{File.join('/projects/',path)}", File.join("/projects/", path) %>
  <% end %>

    <hr />
    <h3>Applications</h3>
  <% if !@sample_invalid_name.keys.empty? %>
    <ul>
      <li><font color=red>Invalid character is used in sample name. Please correct it.</font></li>
      <li>Invalid characters: !@#$%^&*()<>{}[]/:;"='+| and SPACE</li>
    </ul>
  <% elsif @sushi_apps %>
    <%= button_to 'Refresh', "/data_set/#{@data_set.id}/refresh_apps", :method=>:get %>
    <% if @sushi_apps.empty? %>
      <font color=red>No Available Application for this DataSet</font><br />
      <%= button_to 'Back', '/run_application', :method=>:get %>
    <% else %>
      <%= form_tag(:controller => 'run_application', :action => 'set_parameters') do %>
        <%= hidden_field :data_set, :id, :value=>@data_set.id %>
        <table>
          <th>Category</th><th>Application</th>
        <% @sushi_apps_category.each do |category| %>
          <tr><td><%= category %></td>
            <td>
              <% @sushi_apps[category].each do |app| %>
                <%= submit_tag app.to_s, :name=>'app' %>
              <% end %>
            </td>
          </tr>
        <% end %>
        </table>
      <% end %>
    <% end %>
  <% end %>

<hr />
<%= button_to 'Go Job Script&Log', "/data_set/script_log.#{@data_set.id}", :method=>:get %>
<%= button_to 'Show Job Parameter', "/data_set/job_parameter.#{@data_set.id}", :method=>:get %>
