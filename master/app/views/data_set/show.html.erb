<script type="text/javascript">
$(document).ready(function(){
  $('.dt').DataTable();
  $('.dt_no_pager').DataTable({
    "paging": false
  });
  $("#data_set_tree").jstree({
    'core':{
      'data':{
        url: "/data_set/partial_treeviews.<%= params[:id] %>"
      }
    }
  });
});

$(document).ready(function(){
    $("#whole_tree").click(function(){
      $('#data_set_tree').jstree(true).settings.core.data.url = "/data_set/partial_treeviews2.<%= params[:id] %>";
      $("#data_set_tree").jstree(true).refresh();
    });

    var samples_length = $("#data_set_samples_length").val();
    document.getElementById("hide_indicator").removeAttribute("class");
    if(parseInt(samples_length) > 5){
      $("#hide_show").hide();
      $("#hide").html("Show");
      $("#hide_indicator").addClass("arrow-down");

    }else{
      $("#hide_show").show();
      $("#hide").text("Hide");
      $("#hide_indicator").addClass("arrow-up");
    }

    $("#hide").click(function(){

        if ($("#hide_indicator").hasClass("arrow-up")){
          $("#hide_show").hide(500);
          $("#hide").text("Show");
        } else {
          $("#hide_show").show(500);
          $("#hide").text("Hide");
        }

        $("#hide_indicator").toggleClass("arrow-up arrow-down");

    });
    $("#add_comment").click(function(){
      var data_set_id = $("#data_set_id").val();
      var old_comment = $("#data_set_comment").val();
      var new_comment = prompt("add comment", old_comment);

      if (data_set_id != null && new_comment != null) {
        $.post('/data_set/add_comment', {'data_set_id':data_set_id, 'data_set_comment':new_comment});
      }
    });
    $("#edit_name").click(function(){
      var data_set_id = $("#data_set_id").val();
      var old_name = $("#data_set_name").val();
      var new_name = prompt("edit name", old_name);

      if (data_set_id != null && new_name != null) {
        $.post('/data_set/edit_name', {'data_set_id':data_set_id, 'data_set_name':new_name});
      }
    });

});
</script>
<%= render 'shared/td' %>
<h3 id="whole_tree" style="display: inline">DataSets</h3>
- <%= link_to 'comment', '', :id=>"add_comment" %> 
- <%= link_to 'name', '', :id=>"edit_name" %>
<%= hidden_field :data_set, :name, :value=>@data_set.name %>
<%= hidden_field :data_set, :id, :value=>@data_set.id %>
<%= hidden_field :data_set, :comment, :value=>@data_set.comment.to_s %>
- <%= link_to "download", {:action=>"save_as_tsv", :id=>@data_set.id}, :method=>:post %>
- <%= link_to 'scripts', "/data_set/script_log.#{@data_set.id}", :method=>:get %>
- <%= link_to 'parameters', "/data_set/job_parameter.#{@data_set.id}", :method=>:get %>
<% if session[:employee] and @data_set.parent_id and @data_set.child == false %>
- <%= link_to "delete data files", {:action=>"confirm_delete_only_data_files", :id=>@data_set.id}, :method=>:post %>
<% end %>
<% if @can_register_bfabric %>
- <%= link_to "register bfabric", {:action=>"register_bfabric", :id=>@data_set.id}, :data=>{:confirm=>"Are you sure you want to register this dataset? DataSet ID:#{@data_set.id}? It will take some seconds."}, :method=>:post %>
<% end %>

<ul id="data_set_tree" class="filetree"></ul>
<table id="datasets" class="pure-table pure-table-bordered">
<thead>  
  <tr><th>ID</th><th>Name</th><th>Samples</th><th>Parent</th><th>Child(ren)IDs</th><th>Created</th><th>BFabricID</th></tr>
</thead>
  <% if @data_set %>
  <%= hidden_field :data_set, :samples_length, :value => @data_set.samples.length %>
  <tbody>
  <tr>
    <td><%= @data_set.id %></td>
    <td><%= td @data_set.name %></td>
    <td><%= @data_set.samples.length %></td>
    <td><%= link_to td(@data_set.data_set.name), "/data_set/p#{session[:project]}/#{@data_set.parent_id}" if @data_set.data_set %></td>
    <td>
      <% @data_set.data_sets.each do |child| %>
        <%= link_to child.id, "/data_set/#{child.id}" %>
        <%= "," unless child == @data_set.data_sets.last %>
      <% end %>
    </td>
    <td><%= @data_set.created_at.to_s.gsub(/UTC/,'') %></td>
    <% if @data_set.bfabric_id %>
      <td><%= link_to @data_set.bfabric_id, "http://fgcz-bfabric.uzh.ch/bfabric/userlab/show-dataset.html?datasetId=#{@data_set.bfabric_id}&tab=details", target: "_blank" %></td>
    <% else %>
      <td></td>
    <% end %>
  </tr>
  </tbody>
  <% end %>
</table>

<hr />
<h3 style="display: inline">
Samples <button class="btn-link" id="hide">Hide</button><span id="hide_indicator" class="arrow-up"></span>
</h3>
- <%= link_to 'edit', "/sample/#{@data_set.id}", :method=>:post %>
  <% @sample_path.sort.each do |path| %>
    - <%= link_to "#{File.join('/projects/',path)}", File.join("/projects/", path) %>
  <% end %>
<div id="hide_show">
<% if @data_set %>
<% if @data_set.samples.length > 10 %>
<table id="dataset_samples" class="dt pure-table pure-table-bordered">
<% else %>
<table id="dataset_samples" class="dt_no_pager pure-table pure-table-bordered">
<% end %>
<thead>
  <tr>
    <% @data_set.factor_first_headers.each do |header| %>
      <th><%= header %></th>
    <% end %>
  </tr>
</thead>
<tbody>
  <% @data_set.samples.each do |sample| %>
    <tr>
      <% @data_set.factor_first_headers.each do |header| %>
        <td>
          <% unless @file_exist[sample.to_hash[header].to_s] %>
            <span class="alert"><%= File.basename(sample.to_hash[header].to_s) %></span>
          <% else %>
            <% file_path = sample.to_hash[header].to_s %>
            <% file_name = File.basename(file_path) %>
            <% if header.tag?('Link') %>
              <% if file_path =~ /^http/ %>
                <%= link_to td(file_name), file_path, target: "_blank" %>
              <% else %>
                <%= link_to td(file_name), File.join('/projects', file_path) %>
              <% end %>
            <% elsif header.tag?('File') %>
               <%= td file_name %>
            <% elsif @sample_invalid_name[file_name] %>
               <span class="alert"><%= td file_name %></span>
            <% else %>
               <%= td file_path %>
            <% end %>
          <% end %>
        </td>
      <% end %>
    </tr>
  <% end %>
</tbody>
</table>
<% end %>
</div>
<hr />

<% unless @file_exist.values.inject{|a,b| a and b}%>
  <% if @sample_path.length == 1 %>
    <%= button_to "Go gstore", File.join("/projects/", @sample_path.first), :method=>:get %>
  <% end %>
  <span class="alert">RED file(s) or the following does not exist in gstore:</span> <%= SushiFabric::GSTORE_DIR %><br />
  <ul>
  <% @file_exist.select{|file, exist| !exist}.each do |file, exist| %>
    <li><%= file %></li>
  <% end %>
  </ul>
    <hr />
<% end %>

    <h3 style="display: inline">Applications</h3>
  <% if !@sample_invalid_name.keys.empty? %>
    <br />
    <ul>
      <li><span class="alert">Invalid character is used in sample name. Please correct it.</span></li>
      <li>Invalid characters: !@#$%^&*()<>{}[]/:;"='+| and SPACE</li>
    </ul>
  <% elsif @sushi_apps %>
    - <a href="" id="refresh_sushi_list">refresh</a>
    <br />
    <br />
    <%= render :partial => '/data_set/sushi_application_list' %>
  <% end %>

<hr />
